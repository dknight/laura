#!/usr/bin/env lua

package.path = package.path .. ";./src/?.lua;./src/?/init.lua"

local Version = require("laura.Version")

--COMPAT include path fix for lua 5.1 and lua 5.2
if Version[_VERSION] <= Version["Lua 5.2"] then
	package.path = package.path .. ";./?/init.lua"
end

local Context = require("laura.Context")
local fs = require("laura.util.fs")
local helpers = require("laura.util.helpers")
local Labels = require("laura.Labels")
local Reporter = require("laura.reporters.Reporter")
local Runner = require("laura.Runner")
local Terminal = require("laura.Terminal")

local ctx = Context.global()
ctx.config = require("laura.Config")

helpers.processFlags()

local runner = Runner:new()

-- last argument should be directory with tests
local dir = arg[#arg]
if not fs.isDir(dir) then
	dir = ctx.config.Dir
end

if not fs.isDir(dir) and dir ~= "." and dir ~= "./" and dir ~= ".\\" then
	error(dir .. " " .. Labels.ErrorNotADir)
end

local files, fcount = fs.getFiles(dir)
if fcount == 0 then
	print(Labels.NoTests)
	os.exit(ctx.config._exitOK)
end

-- Sorting files in alphabetical order to keep consistency.
for fname in helpers.spairs(files) do
	local chunk, err = loadfile(fname, "t", _G)
	if chunk ~= nil then
		chunk()
	else
		Terminal.printActual(err or Labels.errorSyntax)
		os.exit(ctx.config._exitFailed)
	end
end

local results = runner:runTests()
local genericReporter = Reporter:new(results)

if ctx.config.ReportSummary and #ctx.config.Reporters > 0 then
	genericReporter:report()
end

runner:done()
